---
import LabLayout from "../layouts/LabLayout.astro";
import ExperimentPanel from "../components/ExperimentPanel.astro";
import "../styles/global.css";
---

<LabLayout title="Lab 7 ‚Äî Experiment Table">
  <h1 class="text-3xl font-bold mb-4">üß™ Experiment Table</h1>

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
    <!-- üöÄ CI/CD Trigger Panel -->
    <ExperimentPanel title="Trigger CI/CD">
      <div class="flex items-center space-x-2">
        <div
          id="statusLED"
          class="w-3 h-3 rounded-full bg-gray-700 inline-block shadow-md transition-shadow"
        >
        </div>

        <button
          id="buildBtn"
          class="bg-lab-dim border border-lab-glow px-4 py-2 rounded shadow-glow hover:bg-lab-glow hover:text-black transition"
        >
          Build Now
        </button>
      </div>
    </ExperimentPanel>

    <!-- üìÑ Live Logs Panel -->
    <ExperimentPanel title="Live Logs">
      <ul
        id="buildLog"
        class="text-sm font-mono space-y-1 mt-4"
      >
        Loading...
      </ul>
      <button
        id="clearHistoryBtn"
        class="mt-2 px-3 py-1 text-xs bg-lab-dim border border-red-500 text-red-400 rounded hover:bg-red-500 hover:text-black transition"
      >
        Clear History
      </button>
    </ExperimentPanel>

    <!-- üìä System Metrics -->
    <ExperimentPanel title="System Metrics">
      <p>CPU: 17% | Mem: 62%</p>
    </ExperimentPanel>
  </div>
</LabLayout>

<script is:inline type="module">
  async function triggerBuild() {
    const button = document.getElementById("buildBtn");
    const statusLED = document.getElementById("statusLED");

    button.textContent = "Building...";
    button.disabled = true;
    statusLED.className = "w-3 h-3 rounded-full bg-yellow-300 shadow-pulse";

    try {
      const res = await fetch("http://localhost:8000/trigger/", {
        method: "POST"
      });

      const data = await res.json();
      const isSuccess = res.status === 204;

      statusLED.className = `w-3 h-3 rounded-full ${
        isSuccess ? "bg-green-400 shadow-glow" : "bg-red-400 shadow-pulse"
      }`;

      button.textContent = data.message || "Build triggered!";
    } catch (err) {
      console.error("‚ùå Build trigger failed:", err);
      button.textContent = "Error!";
      statusLED.className = "w-3 h-3 rounded-full bg-red-500 shadow-pulse";
    } finally {
      setTimeout(() => {
        button.textContent = "Build Now";
        button.disabled = false;
        statusLED.className = "w-3 h-3 rounded-full bg-gray-700 shadow-md";
      }, 3000);

      await loadBuildHistory();
    }
  }

  async function loadBuildHistory() {
    const list = document.getElementById("buildLog");
    list.innerHTML = "";

    try {
      const res = await fetch("http://localhost:8000/trigger/history");
      const logs = await res.json();

      if (logs.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No build history yet.";
        li.className = "text-gray-500 text-sm";
        list.appendChild(li);
        return;
      }

      for (const log of logs.reverse()) {
        const li = document.createElement("li");

        const icon = log.status === "success" ? "‚úÖ" : "‚ùå";
        const msgColor = log.status === "success" ? "text-green-400" : "text-red-400";
        const glow = log.status === "success" ? "shadow-glow" : "shadow-pulse";

        li.innerHTML = `
          <span class="font-mono text-xs text-gray-500">[${log.timestamp}]</span>
          <span class="${msgColor} font-semibold ${glow} animate-flicker ml-2">${icon} ${log.message}</span>
        `;

        li.className = "text-gray-200 text-sm";
        list.appendChild(li);
      }
    } catch (err) {
      const li = document.createElement("li");
      li.textContent = "Error loading logs.";
      li.className = "text-red-400 text-sm";
      list.appendChild(li);
      console.error("üî¥ Failed to fetch build history:", err);
    }
  }

  async function clearBuildHistory() {
    try {
      await fetch("http://localhost:8000/trigger/history/clear", {
        method: "POST"
      });
      await loadBuildHistory();
    } catch (err) {
      console.error("‚ö†Ô∏è Error clearing history:", err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const buildBtn = document.getElementById("buildBtn");
    const clearBtn = document.getElementById("clearHistoryBtn");

    if (buildBtn) {
      buildBtn.addEventListener("click", triggerBuild);
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", clearBuildHistory);
    }

    loadBuildHistory();
  });
</script>